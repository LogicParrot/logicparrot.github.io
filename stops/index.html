<!doctype html><html><head><meta charset="utf-8"/><title>Visual Desync</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
	integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
	crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
	integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
	crossorigin=""></script>
	<style>
		#mapid { height: 84vh; }
		table {border-collapse: collapse;}
		table, th, td {border: 1px solid black;}
		.yellow{background-color: yellow}
	</style>
</head><body onload="init()">

<button id="openWithOsm">Open with OSM</button>
<button id="openWithAchavi">Open with Achavi</button>
<a href="https://wiki.openstreetmap.org/wiki/User:SafwatHalaby/scripts/gtfs">More info here</a>
<p>Red - Deleted from OSM, present in GTFS<br>
Pink - Has ref, present on map, but not present in GTFS<br>
| Cyan+darkBlue - 12m+ | Cyan - 5-12m | Cyan+Green - 0-5m | Yellow - Not moved but tags changed.
</p>
<div id="mapid"></div>


<script>
	// UGLY code written as fast as possible. Do not expect elegance.
var map;
var rdius = 13;
function init()
{
	map = L.map('mapid').setView([32, 35], 6);
	
	//tms[19]:https://{switch:a,b,c}.tile.openstreetmap.org/{zoom}/{x}/{y}.png
	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
    subdomains: 'abc',
    maxZoom: 19
	}).addTo(map);
		
	ajax_get("desync.json",function(result)
	{
		var lines = result.split('\n');
		for(var line = 0; line < lines.length; line++){
			if (lines[line].replace(/\s+/g, '') === "") continue;
			addStop(JSON.parse(lines[line]));
		}
	},function()
	{
		alert("Failed to retrieve stops. Try refreshing?");
	}, 10000);
	
	document.getElementById("openWithOsm").onclick = function()
	{
		var url = 'https://www.openstreetmap.org/#map=' + map.getZoom() + '/' + map.getCenter().lat + '/' + map.getCenter().lng;
		var win = window.open(url, '_blank');
		win.focus();
	};
	
	document.getElementById("openWithAchavi").onclick = function()
	{
		var url = 'https://overpass-api.de/achavi/?zoom=' + map.getZoom() + '&lat=' + map.getCenter().lat + '&lon=' + map.getCenter().lng;
		var win = window.open(url, '_blank');
		win.focus();
	};
	
	
}

// {ref: osm: X, gtfs: X}
// X: {lat: num, lon num, tags: {key: val, key: val, etc} }
function addStop(stop)
{
	var circle;
	var tagDiff = {};
	var popup = document.createElement("div");
	
	if (stop.osm !== null)
	{
		if ((stop.gtfs !== null) && ((stop.gtfs.lat !== stop.osm.lat) || (stop.gtfs.lon !== stop.osm.lon)))
		{
			var c,f;
			var dist = getDistanceFromLatLonInM(stop.gtfs.lat, stop.gtfs.lon, stop.osm.lat, stop.osm.lon);
			// moved stop (could be modified tags too)
			if (dist < 5)
			{
				c = "cyan";
				f = "#0F0";
			}
			else if (dist < 12)
			{
				c = "cyan";
				f = "#0FF";
			}
			else
			{
				c = "cyan";
				f = "#005";
			}
			circle = L.circleMarker([stop.osm.lat, stop.osm.lon], {color: c, fillColor: f, fillOpacity:0.5, radius:rdius});
			var polyline = L.polyline([[stop.osm.lat,stop.osm.lon],[stop.gtfs.lat,stop.gtfs.lon]], {color: 'red', fillOpacity:1}).addTo(map);
			circle.addTo(map);
			polyline.addTo(map);
		}
		else if (stop.gtfs !== null)
		{
			// stop with modified tags
			circle = L.circleMarker([stop.osm.lat, stop.osm.lon], {color: 'yellow', fillColor: '#FF0', fillOpacity:0.5, radius:rdius});
			circle.addTo(map);
		}
		else
		{
			// stop in OSM but not in GTFS
			circle = L.circleMarker([stop.osm.lat, stop.osm.lon], {color: 'magenta', fillColor: '#F0F', fillOpacity:0.5, radius:rdius});
			circle.addTo(map);
		}
	}
	else
	{
		// deleted stop (only present in GTFS)
		circle = L.circleMarker([stop.gtfs.lat, stop.gtfs.lon], {color: 'red', fillColor: '#FF', fillOpacity:0.5, radius:rdius});
		circle.addTo(map);
	}
	
	

	
	if (stop.gtfs !== null)
	{
		for (key in stop.gtfs.tags)
		{
			//console.log(key);
			if (stop.gtfs.tags.hasOwnProperty(key))
			{
				tagDiff[key] = {"gtfs": stop.gtfs.tags[key], "osm": ""};
			}
		}
	}
	
	if (stop.osm !== null)
	{
		for (key in stop.osm.tags)
		{
			if (stop.osm.tags.hasOwnProperty(key))
			{
				if (tagDiff[key] === undefined)
					tagDiff[key] = {"osm": stop.osm.tags[key], "gtfs": ""};
				else
					tagDiff[key].osm = stop.osm.tags[key];
			}
		}
	}
	
	var table = document.createElement("table");
	popup.appendChild(table);
	table.style.border = "1";
	
	// header
	var lineHead = document.createElement("tr");
	lineHead.innerHTML = "<td><b>Key</b></td><td><b>GTFS</b></td><td><b>OSM</b></td>";
	table.appendChild(lineHead);
	
	
	for (key in tagDiff)
	{
		if (tagDiff.hasOwnProperty(key))
		{
				var tr = createTableLine(key, tagDiff[key].gtfs, tagDiff[key].osm);
				table.appendChild(tr);
		}
	}
	table.appendChild(createTableLine("lat", stop.gtfs === null ? "" : stop.gtfs.lat, stop.osm === null ? "" : stop.osm.lat));
	table.appendChild(createTableLine("lon", stop.gtfs === null ? "" : stop.gtfs.lon, stop.osm === null ? "" : stop.osm.lon));
	
	if ((stop.gtfs !== null) && (stop.osm !== null) && ((stop.gtfs.lat !== stop.osm.lat) || (stop.gtfs.lon !== stop.osm.lon)))
	{
		var p = document.createElement("p");
		p.innerHTML = "Distance difference: " + getDistanceFromLatLonInM(stop.gtfs.lat, stop.gtfs.lon, stop.osm.lat, stop.osm.lon).toFixed(2)+"m";
		popup.appendChild(p);
	}
	{
		var discussion = stop.extra.discussion;
		var p = document.createElement("p");
		if (discussion !== null)
			p.innerHTML = '<b>Discussion</b>: ' + href('https://www.openstreetmap.org/changeset/' + discussion, '#' + discussion);
		else
			p.innerHTML = '<b>Discussion</b>: N/A'
		popup.appendChild(p);
	}
	{
		var osmId = stop.extra.osmId;
		var p = document.createElement("p");
		if (osmId !== null)
		{
			var nodeUrl = stop.extra.osmType + '/' + osmId;
			var visualHist = href('https://aleung.github.io/osm-visual-history/#/' + nodeUrl, "Visual history");
			var osmElement = href('https://www.openstreetmap.org/' + nodeUrl, nodeUrl);
			p.innerHTML = '<b>OSM ID</b>: ' + osmElement + '--' + visualHist;
		}
		else
			p.innerHTML = '<b>OSM ID</b>: N/A'
		popup.appendChild(p);
	}
	
	circle.bindPopup(popup);
}

function href(url, str)
{
	return '<a href="'+url+'" target="_blank">'+str+'</a>';
}
function createTableLine(key, gtfsVal, osmVal) 
{
	var tr = document.createElement("tr");

	var tdKey = document.createElement("td");
	tr.appendChild(tdKey);
	tdKey.appendChild(document.createTextNode(key));
	
	var tdGtfs = document.createElement("td");
	tr.appendChild(tdGtfs);
	tdGtfs.appendChild(document.createTextNode(gtfsVal));
	
	var tdOsm = document.createElement("td");
	tr.appendChild(tdOsm);
	tdOsm.appendChild(document.createTextNode(osmVal));
	
	if(gtfsVal !== osmVal)
	{
		if ((key == "name:en") || (key == "name:ar") || (key == "name:he") ||
		 (key == "description") || (key == "lat")  || (key == "lon")) // don't color osm-only tags yellow (e.g. wheelchair)
			tr.className = "yellow";
	}
	return tr;
}

function getDistanceFromLatLonInM(lat1,lon1,lat2,lon2) {
  var R = 6371; // Radius of the earth in km
  var dLat = deg2rad(lat2-lat1);  // deg2rad below
  var dLon = deg2rad(lon2-lon1); 
  var a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
    Math.sin(dLon/2) * Math.sin(dLon/2)
    ; 
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  var d = R * c; // Distance in km
  return d * 1000;
}

function deg2rad(deg) {
  return deg * (Math.PI/180)
}

function ajax_get(url,success_callback,fail_callback,timeout)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET",url, true);

    xmlHttp.onreadystatechange=function()
    {
        if (xmlHttp.readyState == 4 ) 
        {
            clearTimeout(xmlHttpTimeout); 
            if(xmlHttp.status == 200)
            {
                success_callback(xmlHttp.responseText);
            }
            else 
            {
                    fail_callback();
            }
        }
    }
    xmlHttp.send();

    var xmlHttpTimeout=setTimeout(ajaxTimeout,timeout);
    function ajaxTimeout()
    {
       xmlHttp.abort();
       fail_callback();
    }

} 

</script>
</body></html>
